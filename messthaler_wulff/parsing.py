import logging
import re

log = logging.getLogger("messthaler_wulff")

int_re = re.compile(r"[+-]?\d+(?:\.0)?")
atom_re = re.compile(fr"\((\s*{int_re.pattern}\s*(?:,\s*{int_re.pattern}\s*)*),?\s*\)")
crystal_re = re.compile(r"\s*\[\s*"
                        r"(?:"
                        rf"{atom_re.pattern}"
                        rf"(?:\s*,\s*{atom_re.pattern}\s*)*"
                        r")?"
                        r"\s*]\s*")

allowed_characters = frozenset("0123456789.,()[]+- ")


def parse_atom(string: str) -> tuple:
    ints = map(lambda x: x.split(".")[0], int_re.findall(string))
    return tuple(map(int, ints))


def parse_crystal(string: str) -> list[tuple]:
    if not crystal_re.fullmatch(string):
        log.error(f"String does not match crystal format: {string}")
        characters = frozenset(string)
        if not characters < allowed_characters:
            log.error(f"You used the following illegal characters: {characters - allowed_characters}")
        string = string.strip()
        if string[0] != "[" or string[-1] != "]":
            log.error(f"String does not begin or end with '[' and ']'")
        exit(0)

    return list(map(parse_atom, atom_re.findall(string)))

# print(parse_crystal("[(1.0)]"))
# print(parse_crystal("[(-3.0,4.0,4.0),(-4.0,3.0,5.0),(-4.0,5.0,3.0),(-5.0,4.0,4.0),(5.0,-4.0,-4.0),(4.0,-5.0,-3.0),(4.0,-3.0,-5.0),(3.0,-4.0,-4.0),(4.0,-3.0,4.0),(3.0,-4.0,5.0),(5.0,-4.0,3.0),(4.0,-5.0,4.0),(-4.0,5.0,-4.0),(-5.0,4.0,-3.0),(-3.0,4.0,-5.0),(-4.0,3.0,-4.0),(4.0,4.0,-3.0),(3.0,5.0,-4.0),(5.0,3.0,-4.0),(4.0,4.0,-5.0),(-4.0,-4.0,5.0),(-5.0,-3.0,4.0),(-3.0,-5.0,4.0),(-4.0,-4.0,3.0),(-2.0,6.0,2.0),(-6.0,2.0,6.0),(-2.0,2.0,6.0),(-6.0,6.0,2.0),(-4.0,4.0,4.0),(6.0,-2.0,-6.0),(2.0,-6.0,-2.0),(6.0,-6.0,-2.0),(2.0,-2.0,-6.0),(4.0,-4.0,-4.0),(4.0,4.0,-4.0),(-4.0,-4.0,4.0),(4.0,-4.0,4.0),(-4.0,4.0,-4.0),(-2.0,4.0,4.0),(-4.0,2.0,6.0),(-4.0,6.0,2.0),(-6.0,4.0,4.0),(6.0,-4.0,-4.0),(4.0,-6.0,-2.0),(4.0,-2.0,-6.0),(2.0,-4.0,-4.0),(0.0,6.0,0.0),(0.0,4.0,2.0),(0.0,2.0,4.0),(0.0,0.0,6.0),(-2.0,0.0,6.0),(-4.0,0.0,6.0),(-6.0,0.0,6.0),(-6.0,2.0,4.0),(-6.0,4.0,2.0),(-6.0,6.0,0.0),(-2.0,6.0,0.0),(-4.0,6.0,0.0),(6.0,0.0,-6.0),(6.0,-2.0,-4.0),(6.0,-4.0,-2.0),(6.0,-6.0,0.0),(4.0,-6.0,0.0),(2.0,-6.0,0.0),(0.0,-6.0,0.0),(0.0,-4.0,-2.0),(0.0,-2.0,-4.0),(0.0,0.0,-6.0),(4.0,0.0,-6.0),(2.0,0.0,-6.0),(2.0,0.0,4.0),(2.0,2.0,2.0),(2.0,4.0,0.0),(0.0,-2.0,6.0),(-2.0,-2.0,6.0),(-4.0,-2.0,6.0),(-4.0,6.0,-2.0),(-2.0,6.0,-2.0),(0.0,6.0,-2.0),(-6.0,4.0,0.0),(-6.0,2.0,2.0),(-6.0,0.0,4.0),(6.0,-4.0,0.0),(6.0,-2.0,-2.0),(6.0,0.0,-4.0),(4.0,-6.0,2.0),(2.0,-6.0,2.0),(0.0,-6.0,2.0),(0.0,2.0,-6.0),(2.0,2.0,-6.0),(4.0,2.0,-6.0),(-2.0,0.0,-4.0),(-2.0,-2.0,-2.0),(-2.0,-4.0,0.0),(4.0,-2.0,4.0),(2.0,-4.0,6.0),(-4.0,6.0,-4.0),(-6.0,4.0,-2.0),(4.0,4.0,-2.0),(2.0,6.0,-4.0),(-4.0,-4.0,6.0),(-6.0,-2.0,4.0),(4.0,0.0,2.0),(4.0,2.0,0.0),(0.0,-4.0,6.0),(-2.0,-4.0,6.0),(-2.0,6.0,-4.0),(0.0,6.0,-4.0),(-6.0,2.0,0.0),(-6.0,0.0,2.0),(6.0,-4.0,2.0),(4.0,-6.0,4.0),(-2.0,4.0,-6.0),(-4.0,2.0,-4.0),(6.0,2.0,-4.0),(4.0,4.0,-6.0),(-2.0,-6.0,4.0),(-4.0,-4.0,2.0),(6.0,-2.0,0.0),(6.0,0.0,-2.0),(2.0,-6.0,4.0),(0.0,-6.0,4.0),(0.0,4.0,-6.0),(2.0,4.0,-6.0),(-4.0,0.0,-2.0),(-4.0,-2.0,0.0),(6.0,0.0,0.0),(0.0,-6.0,6.0),(0.0,6.0,-6.0),(-6.0,0.0,0.0),(6.0,-2.0,2.0),(2.0,-6.0,6.0),(2.0,-2.0,6.0),(6.0,-6.0,2.0),(-2.0,6.0,-6.0),(-6.0,2.0,-2.0),(-6.0,6.0,-2.0),(-2.0,2.0,-6.0),(6.0,2.0,-2.0),(2.0,6.0,-2.0),(2.0,6.0,-6.0),(6.0,2.0,-6.0),(-2.0,-6.0,6.0),(-6.0,-2.0,2.0),(-2.0,-6.0,2.0),(-6.0,-2.0,6.0),(-1.0,6.0,1.0),(-1.0,5.0,2.0),(-1.0,4.0,3.0),(-1.0,3.0,4.0),(-1.0,2.0,5.0),(-1.0,1.0,6.0),(-6.0,1.0,6.0),(-5.0,1.0,6.0),(-4.0,1.0,6.0),(-3.0,1.0,6.0),(-2.0,1.0,6.0),(-2.0,6.0,1.0),(-3.0,6.0,1.0),(-4.0,6.0,1.0),(-5.0,6.0,1.0),(-6.0,6.0,1.0),(-6.0,2.0,5.0),(-6.0,3.0,4.0),(-6.0,4.0,3.0),(-6.0,5.0,2.0),(6.0,-1.0,-6.0),(6.0,-2.0,-5.0),(6.0,-3.0,-4.0),(6.0,-4.0,-3.0),(6.0,-5.0,-2.0),(6.0,-6.0,-1.0),(1.0,-6.0,-1.0),(2.0,-6.0,-1.0),(3.0,-6.0,-1.0),(4.0,-6.0,-1.0),(5.0,-6.0,-1.0),(5.0,-1.0,-6.0),(4.0,-1.0,-6.0),(3.0,-1.0,-6.0),(2.0,-1.0,-6.0),(1.0,-1.0,-6.0),(1.0,-5.0,-2.0),(1.0,-4.0,-3.0),(1.0,-3.0,-4.0),(1.0,-2.0,-5.0),(0.0,5.0,1.0),(0.0,3.0,3.0),(0.0,1.0,5.0),(-5.0,0.0,6.0),(-3.0,0.0,6.0),(-1.0,0.0,6.0),(-1.0,6.0,0.0),(-3.0,6.0,0.0),(-5.0,6.0,0.0),(-6.0,1.0,5.0),(-6.0,3.0,3.0),(-6.0,5.0,1.0),(6.0,-1.0,-5.0),(6.0,-3.0,-3.0),(6.0,-5.0,-1.0),(1.0,-6.0,0.0),(3.0,-6.0,0.0),(5.0,-6.0,0.0),(5.0,0.0,-6.0),(3.0,0.0,-6.0),(1.0,0.0,-6.0),(0.0,-5.0,-1.0),(0.0,-3.0,-3.0),(0.0,-1.0,-5.0),(1.0,5.0,0.0),(1.0,4.0,1.0),(1.0,3.0,2.0),(1.0,2.0,3.0),(1.0,1.0,4.0),(1.0,0.0,5.0),(-5.0,-1.0,6.0),(-4.0,-1.0,6.0),(-3.0,-1.0,6.0),(-2.0,-1.0,6.0),(-1.0,-1.0,6.0),(0.0,-1.0,6.0),(0.0,6.0,-1.0),(-1.0,6.0,-1.0),(-2.0,6.0,-1.0),(-3.0,6.0,-1.0),(-4.0,6.0,-1.0),(-5.0,6.0,-1.0),(-6.0,0.0,5.0),(-6.0,1.0,4.0),(-6.0,2.0,3.0),(-6.0,3.0,2.0),(-6.0,4.0,1.0),(-6.0,5.0,0.0),(6.0,0.0,-5.0),(6.0,-1.0,-4.0),(6.0,-2.0,-3.0),(6.0,-3.0,-2.0),(6.0,-4.0,-1.0),(6.0,-5.0,0.0),(0.0,-6.0,1.0),(1.0,-6.0,1.0),(2.0,-6.0,1.0),(3.0,-6.0,1.0),(4.0,-6.0,1.0),(5.0,-6.0,1.0),(5.0,1.0,-6.0),(4.0,1.0,-6.0),(3.0,1.0,-6.0),(2.0,1.0,-6.0),(1.0,1.0,-6.0),(0.0,1.0,-6.0),(-1.0,-5.0,0.0),(-1.0,-4.0,-1.0),(-1.0,-3.0,-2.0),(-1.0,-2.0,-3.0),(-1.0,-1.0,-4.0),(-1.0,0.0,-5.0),(2.0,-1.0,5.0),(2.0,1.0,3.0),(2.0,3.0,1.0),(2.0,5.0,-1.0),(1.0,-2.0,6.0),(-1.0,-2.0,6.0),(-3.0,-2.0,6.0),(-5.0,-2.0,6.0),(-5.0,6.0,-2.0),(-3.0,6.0,-2.0),(-1.0,6.0,-2.0),(1.0,6.0,-2.0),(-6.0,5.0,-1.0),(-6.0,3.0,1.0),(-6.0,1.0,3.0),(-6.0,-1.0,5.0),(6.0,-5.0,1.0),(6.0,-3.0,-1.0),(6.0,-1.0,-3.0),(6.0,1.0,-5.0),(5.0,-6.0,2.0),(3.0,-6.0,2.0),(1.0,-6.0,2.0),(-1.0,-6.0,2.0),(-1.0,2.0,-6.0),(1.0,2.0,-6.0),(3.0,2.0,-6.0),(5.0,2.0,-6.0),(-2.0,1.0,-5.0),(-2.0,-1.0,-3.0),(-2.0,-3.0,-1.0),(-2.0,-5.0,1.0),(3.0,-1.0,4.0),(3.0,0.0,3.0),(3.0,1.0,2.0),(3.0,2.0,1.0),(3.0,3.0,0.0),(3.0,4.0,-1.0),(1.0,-3.0,6.0),(0.0,-3.0,6.0),(-1.0,-3.0,6.0),(-2.0,-3.0,6.0),(-3.0,-3.0,6.0),(-4.0,-3.0,6.0),(-4.0,6.0,-3.0),(-3.0,6.0,-3.0),(-2.0,6.0,-3.0),(-1.0,6.0,-3.0),(0.0,6.0,-3.0),(1.0,6.0,-3.0),(-6.0,4.0,-1.0),(-6.0,3.0,0.0),(-6.0,2.0,1.0),(-6.0,1.0,2.0),(-6.0,0.0,3.0),(-6.0,-1.0,4.0),(6.0,-4.0,1.0),(6.0,-3.0,0.0),(6.0,-2.0,-1.0),(6.0,-1.0,-2.0),(6.0,0.0,-3.0),(6.0,1.0,-4.0),(4.0,-6.0,3.0),(3.0,-6.0,3.0),(2.0,-6.0,3.0),(1.0,-6.0,3.0),(0.0,-6.0,3.0),(-1.0,-6.0,3.0),(-1.0,3.0,-6.0),(0.0,3.0,-6.0),(1.0,3.0,-6.0),(2.0,3.0,-6.0),(3.0,3.0,-6.0),(4.0,3.0,-6.0),(-3.0,1.0,-4.0),(-3.0,0.0,-3.0),(-3.0,-1.0,-2.0),(-3.0,-2.0,-1.0),(-3.0,-3.0,0.0),(-3.0,-4.0,1.0),(4.0,-1.0,3.0),(4.0,1.0,1.0),(4.0,3.0,-1.0),(1.0,-4.0,6.0),(-1.0,-4.0,6.0),(-3.0,-4.0,6.0),(-3.0,6.0,-4.0),(-1.0,6.0,-4.0),(1.0,6.0,-4.0),(-6.0,3.0,-1.0),(-6.0,1.0,1.0),(-6.0,-1.0,3.0),(4.0,-1.0,3.0),(6.0,-1.0,-1.0),(6.0,1.0,-3.0),(3.0,-6.0,4.0),(1.0,-6.0,4.0),(-1.0,-6.0,4.0),(-1.0,4.0,-6.0),(1.0,4.0,-6.0),(3.0,4.0,-6.0),(-4.0,1.0,-3.0),(-4.0,-1.0,-1.0),(-4.0,-3.0,1.0),(5.0,-1.0,2.0),(5.0,0.0,1.0),(5.0,1.0,0.0),(5.0,2.0,-1.0),(1.0,-5.0,6.0),(0.0,-5.0,6.0),(-1.0,-5.0,6.0),(-2.0,-5.0,6.0),(-2.0,6.0,-5.0),(-1.0,6.0,-5.0),(0.0,6.0,-5.0),(1.0,6.0,-5.0),(-6.0,2.0,-1.0),(-6.0,1.0,0.0),(-6.0,0.0,1.0),(-6.0,-1.0,2.0),(6.0,-2.0,1.0),(6.0,-1.0,0.0),(6.0,0.0,-1.0),(6.0,1.0,-2.0),(2.0,-6.0,5.0),(1.0,-6.0,5.0),(0.0,-6.0,5.0),(-1.0,-6.0,5.0),(-1.0,5.0,-6.0),(0.0,5.0,-6.0),(1.0,5.0,-6.0),(2.0,5.0,-6.0),(-5.0,1.0,-2.0),(-5.0,0.0,-1.0),(-5.0,-1.0,0.0),(-5.0,-2.0,1.0),(6.0,-1.0,1.0),(6.0,1.0,-1.0),(1.0,-6.0,6.0),(-1.0,-6.0,6.0),(-1.0,6.0,-6.0),(1.0,6.0,-6.0),(-6.0,1.0,-1.0),(-6.0,-1.0,1.0),(-2.0,5.0,3.0),(-2.0,3.0,5.0),(-5.0,2.0,6.0),(-3.0,2.0,6.0),(-3.0,6.0,2.0),(-5.0,6.0,2.0),(-6.0,3.0,5.0),(-6.0,5.0,3.0),(6.0,-3.0,-5.0),(6.0,-5.0,-3.0),(3.0,-6.0,-2.0),(5.0,-6.0,-2.0),(5.0,-2.0,-6.0),(3.0,-2.0,-6.0),(2.0,-5.0,-3.0),(2.0,-3.0,-5.0),(5.0,-2.0,3.0),(3.0,-2.0,5.0),(2.0,-5.0,6.0),(2.0,-3.0,6.0),(6.0,-3.0,2.0),(6.0,-5.0,2.0),(3.0,-6.0,5.0),(5.0,-6.0,3.0),(-3.0,6.0,-5.0),(-5.0,6.0,-3.0),(-6.0,3.0,-2.0),(-6.0,5.0,-2.0),(-2.0,5.0,-6.0),(-2.0,3.0,-6.0),(-5.0,2.0,-3.0),(-3.0,2.0,-5.0),(5.0,3.0,-2.0),(3.0,5.0,-2.0),(2.0,6.0,-5.0),(2.0,6.0,-3.0),(6.0,2.0,-3.0),(6.0,2.0,-5.0),(3.0,5.0,-6.0),(5.0,3.0,-6.0),(-3.0,-5.0,6.0),(-5.0,-3.0,6.0),(-6.0,-2.0,3.0),(-6.0,-2.0,5.0),(-2.0,-6.0,5.0),(-2.0,-6.0,3.0),(-5.0,-3.0,2.0),(-3.0,-5.0,2.0),(-3.0,5.0,3.0),(-5.0,3.0,5.0),(-3.0,3.0,5.0),(-5.0,5.0,3.0),(5.0,-3.0,-5.0),(3.0,-5.0,-3.0),(5.0,-5.0,-3.0),(3.0,-3.0,-5.0),(5.0,-3.0,3.0),(3.0,-5.0,5.0),(3.0,-3.0,5.0),(5.0,-5.0,3.0),(-3.0,5.0,-5.0),(-5.0,3.0,-3.0),(-5.0,5.0,-3.0),(-3.0,3.0,-5.0),(5.0,3.0,-3.0),(3.0,5.0,-3.0),(3.0,5.0,-5.0),(5.0,3.0,-5.0),(-3.0,-5.0,5.0),(-5.0,-3.0,5.0),(-5.0,-3.0,3.0),(-3.0,-5.0,3.0)]"))
